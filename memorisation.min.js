let textData=[];const textInputLimit=5e3;class LineData{static latestID=0;constructor(e){this.id=++LineData.latestID,this.p=create("p",{id:"textLine"+this.id,className:"textLine hidden"},"textDisplay"),this.revealedText=create("span",{className:"textSpan"},this.p),this.hiddenText=create("span",{textContent:e},this.p),this.exposed=!1,this.hiddenWordSpans(),this.revealedText.addEventListener("click",(()=>{let e=window.getSelection().anchorOffset;for(;e>0&&" "!==this.revealedText.textContent[e-1];)e--;this.hiddenText.textContent=this.revealedText.textContent.slice(e)+this.hiddenText.textContent,this.revealedText.textContent=this.revealedText.textContent.slice(0,e),this.exposed=!1,this.p.classList.add("hidden"),hideLinesAfter(this.id),this.hiddenWordSpans()})),this.hiddenText.addEventListener("click",(e=>{revealLinesBefore(this.id);const t=e.target.classList.contains("initial")?e.target.parentElement:e.target;if(t["data-spanCount"]){let e=t["data-spanCount"];for(;e-- >0;)this.revealedText.textContent=this.revealedText.textContent+this.hiddenText.firstChild.textContent,this.hiddenText.removeChild(this.hiddenText.firstChild);this.hiddenText.firstChild&&" "===this.hiddenText.firstChild.textContent&&(this.revealedText.textContent=this.revealedText.textContent+this.hiddenText.firstChild.textContent,this.hiddenText.removeChild(this.hiddenText.firstChild)),this.checkLineRevealed()}else this.revealLine();this.hiddenWordSpans(),this.scrollIntoView()})),this.p.addEventListener("click",(e=>{"P"===e.target.tagName&&(this.exposed?hideLinesAfter(this.id):revealLinesUpTo(this.id))}))}checkLineRevealed(){(0===this.hiddenText.textContent.length||this.hiddenText.textContent.split("").every((e=>" "===e)))&&(this.exposed=!0,this.p.classList.remove("hidden"))}hiddenWordSpans(){let e=this.revealedText.textContent.split(""),t=e.findLastIndex((e=>e.match(/[a-zA-Z0-9]/)))<=e.lastIndexOf(" "),i=this.hiddenText.textContent;this.hiddenText.textContent="";let n=-1,s=0,o=0;for(let e of i){if(" "===e||s===i.length-1){if(s===i.length-1&&" "!==e&&(-1===n&&(n=s),s++),-1!==n){const e=create("span",{className:"textSpan hidden","data-spanCount":++o},this.hiddenText);let a=i.slice(n,s);if(t){let t=0,i=a.match(/[a-zA-Z1-9]/);i&&(t=i.index),e.appendChild(document.createTextNode(a.slice(0,t))),e.appendChild(create("span",{className:"textSpan hidden initial",textContent:a[t]})),e.appendChild(document.createTextNode(a.slice(t+1)))}else e.appendChild(document.createTextNode(a));t=!0,n=-1}" "===e&&create("span",{className:"textSpan space",textContent:" ","data-spanCount":++o},this.hiddenText)}else-1===n&&(n=s);s++}}revealCharacter(){const e=this.hiddenText.textContent[0];return this.revealedText.textContent+=e,this.hiddenText.textContent=this.hiddenText.textContent.slice(1),this.checkLineRevealed(),this.hiddenWordSpans(),e}revealLetter(){this.scrollIntoView();let e=!1;do{this.revealCharacter().match(/[a-zA-Z0-9]/)&&(e=!0)}while(!this.exposed&&(!e||" "!==this.hiddenText.textContent[0]&&!this.hiddenText.textContent[0].match(/[a-zA-Z0-9]/)));this.exposed||" "!==this.hiddenText.textContent[0]||this.revealCharacter()}revealWord(){this.scrollIntoView();let e=!1;do{" "!==this.revealCharacter()&&(e=!0)}while(!(this.exposed||e&&" "===this.hiddenText.textContent[0]));this.exposed||" "!==this.hiddenText.textContent[0]||this.revealCharacter()}revealLine(e=!0){e&&this.scrollIntoView(),this.revealedText.textContent+=this.hiddenText.textContent,this.hiddenText.textContent="",this.exposed=!0,this.p.classList.remove("hidden")}hideLine(){this.exposed=!1,this.p.classList.add("hidden"),this.hiddenText.textContent=this.revealedText.textContent+this.hiddenText.textContent,this.revealedText.textContent="",this.hiddenWordSpans()}scrollIntoView(){let e=this.p.getBoundingClientRect();if(e.top<0)scroll(window.scrollX,window.scrollY-5+e.top);else{let t=elid("bottomBar").getBoundingClientRect().top;t<e.bottom&&scroll(window.scrollX,window.scrollY+5+(e.bottom-t))}}}function hideLinesAfter(e){textData.forEach((t=>{t.id>e&&t.hideLine()}))}function revealLinesBefore(e){textData.forEach((t=>{!t.exposed&&t.id<e&&t.revealLine(!1)}))}function revealLinesUpTo(e){textData.forEach((t=>{!t.exposed&&t.id<=e&&t.revealLine(!1)}))}function inputUpdate(){let e=elid("textInput").value,t=5e3-e.length;elid("charactersRemaining").textContent=t+" characters remaining",localStorage.setItem("currentText",e.slice(0,5e3))}function memorise(){textData=[],elid("textDisplay").replaceChildren();let e=elid("textInput").value;if(0===e.length)alert("Type some text to memorise in the box. Linebreaks will be helpful."),elid("textInput").focus();else if(e.length>5e3)alert("Exceeds maximum text length of 5000 characters.");else{e=e.replace(/\r/g,"\n"),e.split("\n").map((e=>e.trim())).forEach((e=>{e.length>0&&textData.push(new LineData(e))})),elid("textInputSection").style.display="none",elid("memorisationSection").style.display="block",scroll(0,0),document.body.addEventListener("keypress",keypressHandler)}}function edit(){textData=[],elid("textDisplay").replaceChildren(),inputUpdate(),elid("textInputSection").style.display="block",elid("memorisationSection").style.display="none",document.body.removeEventListener("keypress",keypressHandler),elid("textInput").focus()}function activeLine(){return textData.find((e=>!e.exposed))}function showOptions(){elid("memorisationSection").classList.add("showOptions")}function hideOptions(){elid("memorisationSection").classList.remove("showOptions")}function keypressHandler(e){let t;switch(e.preventDefault(),e.code){case"KeyZ":revealSection("letter"),t=elid("revealLetter");break;case"KeyX":revealSection("word"),t=elid("revealWord");break;case"KeyC":revealSection("line"),t=elid("revealLine");break;case"KeyE":edit();break}t&&(t.classList.add("activatedButton"),setTimeout((()=>t.classList.remove("activatedButton")),100))}function revealSection(e){const t=activeLine();if(t)switch(e){case"letter":t.revealLetter();break;case"word":t.revealWord();break;case"line":t.revealLine();break}}function localSave(){const e=localStorage.getItem("savedTexts"),t=e?JSON.parse(e):[];t.push(elid("textInput").value),localStorage.setItem("savedTexts",JSON.stringify(t)),createSavedTextButtons(),scrollTo(0,window.innerHeight)}function createSavedTextButtons(){elid("localTexts").replaceChildren();let e=localStorage.getItem("savedTexts"),t=[];e&&(t=JSON.parse(e)).length>0?(t.forEach(((e,t)=>{const i=create("div",{},"localTexts");create("button",{onclick:()=>deleteLocalText(t),className:"deleteButton",innerHTML:trashSVG},i),create("button",{onclick:()=>loadLocalText(e),className:"loadButton",textContent:e.slice(0,30)+"..."},i)})),elid("localTextsInfo").style.display="block",elid("localTextsEmptyInfo").style.display="none"):(elid("localTextsEmptyInfo").style.display="block",elid("localTextsInfo").style.display="none")}function loadLocalText(e){elid("textInput").value=e,elid("textInput").scroll(0,0),inputUpdate()}function deleteLocalText(e){let t=JSON.parse(localStorage.getItem("savedTexts"));t.splice(e,1),localStorage.setItem("savedTexts",JSON.stringify(t)),createSavedTextButtons()}function clearText(){elid("textInput").value="",inputUpdate()}const trashSVG='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">\n  <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528M8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5"/>\n</svg>';elid("textInput").maxLength=5e3,elid("textInput").oninput=inputUpdate,elid("textInputSubmit").onclick=memorise,elid("textLocalSave").onclick=localSave,elid("clearText").onclick=clearText,elid("changeText").onclick=edit,elid("options").onclick=showOptions,elid("closeOptionsWindow").onclick=hideOptions,elid("revealLetter").onclick=()=>revealSection("letter"),elid("revealWord").onclick=()=>revealSection("word"),elid("revealLine").onclick=()=>revealSection("line"),elid("footerYear").textContent=(new Date).getFullYear();let currentText=localStorage.getItem("currentText");function setSavedOptions(){let e=0;elid("memorisationSection").classList.contains("showLineLengths")&&e++,elid("memorisationSection").classList.contains("showWordLengths")&&e++,elid("memorisationSection").classList.contains("revealInitials")&&e++,localStorage.setItem("localOptions",e)}currentText&&(elid("textInput").value=currentText.slice(0,5e3)),inputUpdate(),createSavedTextButtons(),elid("optionRevealLineLengths").onchange=()=>{elid("optionRevealLineLengths").checked?elid("memorisationSection").classList.add("showLineLengths"):(elid("memorisationSection").classList.remove("showLineLengths"),elid("optionRevealWordLengths").checked=!1,elid("memorisationSection").classList.remove("showWordLengths"),elid("optionRevealInitials").checked=!1,elid("memorisationSection").classList.remove("revealInitials")),setSavedOptions()},elid("optionRevealWordLengths").onchange=()=>{elid("optionRevealWordLengths").checked?(elid("memorisationSection").classList.add("showWordLengths"),elid("optionRevealLineLengths").checked=!0,elid("memorisationSection").classList.add("showLineLengths")):(elid("memorisationSection").classList.remove("showWordLengths"),elid("optionRevealInitials").checked=!1,elid("memorisationSection").classList.remove("revealInitials")),setSavedOptions()},elid("optionRevealInitials").onchange=()=>{elid("optionRevealInitials").checked?(elid("memorisationSection").classList.add("revealInitials"),elid("optionRevealLineLengths").checked=!0,elid("memorisationSection").classList.add("showLineLengths"),elid("optionRevealWordLengths").checked=!0,elid("memorisationSection").classList.add("showWordLengths")):elid("memorisationSection").classList.remove("revealInitials"),setSavedOptions()};let localOptions=localStorage.getItem("localOptions");localOptions&&(localOptions=parseInt(localOptions),localOptions<3&&(elid("optionRevealInitials").checked=!1,elid("memorisationSection").classList.remove("revealInitials")),localOptions<2&&(elid("optionRevealWordLengths").checked=!1,elid("memorisationSection").classList.remove("showWordLengths")),localOptions<1&&(elid("optionRevealLineLengths").checked=!1,elid("memorisationSection").classList.remove("showLineLengths")));const strangeMeeting="It seemed that out of battle I escaped\nDown some profound dull tunnel, long since scooped\nThrough granites which titanic wars had groined.\n\nYet also there encumbered sleepers groaned,\nToo fast in thought or death to be bestirred.\nThen, as I probed them, one sprang up, and stared\nWith piteous recognition in fixed eyes,\nLifting distressful hands, as if to bless.\nAnd by his smile, I knew that sullen hall,— \nBy his dead smile I knew we stood in Hell.\n\nWith a thousand fears that vision's face was grained;\nYet no blood reached there from the upper ground,\nAnd no guns thumped, or down the flues made moan.\n“Strange friend,” I said, “here is no cause to mourn.” \n“None,” said that other, “save the undone years,\nThe hopelessness. Whatever hope is yours,\nWas my life also; I went hunting wild\nAfter the wildest beauty in the world,\nWhich lies not calm in eyes, or braided hair,\nBut mocks the steady running of the hour,\nAnd if it grieves, grieves richlier than here.\nFor by my glee might many men have laughed,\nAnd of my weeping something had been left,\nWhich must die now. I mean the truth untold,\nThe pity of war, the pity war distilled.\nNow men will go content with what we spoiled.\nOr, discontent, boil bloody, and be spilled.\nThey will be swift with swiftness of the tigress. \nNone will break ranks, though nations trek from progress.\nCourage was mine, and I had mystery;\nWisdom was mine, and I had mastery: \nTo miss the march of this retreating world\nInto vain citadels that are not walled.\nThen, when much blood had clogged their chariot-wheels, \nI would go up and wash them from sweet wells,\nEven with truths that lie too deep for taint.\nI would have poured my spirit without stint\nBut not through wounds; not on the cess of war.\nForeheads of men have bled where no wounds were.\n\n“I am the enemy you killed, my friend.\nI knew you in this dark: for so you frowned\nYesterday through me as you jabbed and killed.\nI parried; but my hands were loath and cold.\nLet us sleep now. . . .”";